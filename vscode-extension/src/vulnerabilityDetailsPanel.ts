import * as vscode from 'vscode';
import { ApiClient } from './apiClient';
import { ChatbotPanel } from './chatbotPanel';

export class VulnerabilityDetailsPanel {
    private static currentPanel: VulnerabilityDetailsPanel | undefined;
    private readonly panel: vscode.WebviewPanel;
    private disposables: vscode.Disposable[] = [];
    private currentFinding: any;

    private constructor(panel: vscode.WebviewPanel, private apiClient: ApiClient, finding: any) {
        this.panel = panel;
        this.currentFinding = finding;
        this.panel.onDidDispose(() => this.dispose(), null, this.disposables);

        this.panel.webview.onDidReceiveMessage(
            async (message) => {
                switch (message.command) {
                    case 'applyFix':
                        await this.applyFix();
                        break;
                    case 'applyAndCommit':
                        await this.applyFixAndCommit();
                        break;
                    case 'markResolved':
                        await this.markAsResolved();
                        break;
                    case 'markFalsePositive':
                        await this.markAsFalsePositive();
                        break;
                    case 'openFile':
                        await this.openFileAtLine();
                        break;
                    case 'copyCode':
                        await this.copyRemediationCode();
                        break;
                    case 'discussWithAI':
                        await this.openChatbotWithContext();
                        break;
                }
            },
            null,
            this.disposables
        );
    }

    public static show(finding: any, apiClient: ApiClient) {
        const column = vscode.ViewColumn.Two;

        if (VulnerabilityDetailsPanel.currentPanel) {
            VulnerabilityDetailsPanel.currentPanel.currentFinding = finding;
            VulnerabilityDetailsPanel.currentPanel.panel.reveal(column);
            VulnerabilityDetailsPanel.currentPanel.update();
        } else {
            const panel = vscode.window.createWebviewPanel(
                'vulnerabilityDetails',
                'Vulnerability Details',
                column,
                {
                    enableScripts: true,
                    retainContextWhenHidden: true,
                    localResourceRoots: []
                }
            );

            VulnerabilityDetailsPanel.currentPanel = new VulnerabilityDetailsPanel(panel, apiClient, finding);
            VulnerabilityDetailsPanel.currentPanel.update();
        }
    }

    private update() {
        this.panel.title = `üêõ ${this.currentFinding.title}`;
        this.panel.webview.html = this.getHtmlContent();
    }

    private async applyFix() {
        const finding = this.currentFinding;

        if (!finding.remediation_code) {
            vscode.window.showWarningMessage('No remediation code available');
            return;
        }

        try {
            await vscode.window.withProgress({
                location: vscode.ProgressLocation.Notification,
                title: 'Applying fix...',
                cancellable: false
            }, async () => {
                const document = await vscode.workspace.openTextDocument(finding.file);
                await vscode.window.showTextDocument(document);

                const edit = new vscode.WorkspaceEdit();
                const line = Math.max(0, (finding.line || 1) - 1);
                const lineText = document.lineAt(line);
                const range = lineText.range;

                edit.replace(document.uri, range, finding.remediation_code);

                const success = await vscode.workspace.applyEdit(edit);

                if (success) {
                    await document.save();
                    vscode.window.showInformationMessage('‚úÖ Fix applied successfully!');
                    this.panel.webview.postMessage({ command: 'fixApplied' });
                }
            });
        } catch (error: any) {
            vscode.window.showErrorMessage('Failed to apply fix: ' + error.message);
        }
    }

    private async applyFixAndCommit() {
        await this.applyFix();

        const finding = this.currentFinding;

        // Prompt user for commit confirmation
        const commit = await vscode.window.showQuickPick(['Yes, commit changes', 'No, just apply fix'], {
            placeHolder: 'Do you want to commit this fix to git?'
        });

        if (commit !== 'Yes, commit changes') {
            return;
        }

        try {
            await vscode.window.withProgress({
                location: vscode.ProgressLocation.Notification,
                title: 'Committing fix to git...',
                cancellable: false
            }, async () => {
                const terminal = vscode.window.createTerminal({
                    name: 'AppSec Auto-Remediation',
                    hideFromUser: false
                });

                terminal.show();

                const commitMsg = `fix(security): ${finding.title}

Auto-remediated by AppSec AI Scanner

Severity: ${finding.severity}
CWE: ${finding.cwe_id || 'N/A'}
File: ${finding.file}:${finding.line}

ü§ñ Generated by AppSec AI Scanner`;

                // Escape quotes in file path
                const safeFilePath = finding.file.replace(/"/g, '\\"');

                terminal.sendText(`git add "${safeFilePath}"`);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Use heredoc for multiline commit message
                terminal.sendText(`git commit -m "${commitMsg.replace(/\n/g, '\\n')}"`);

                vscode.window.showInformationMessage('‚úÖ Fix applied and committed to git!');
            });
        } catch (error: any) {
            vscode.window.showErrorMessage('Failed to commit: ' + error.message);
        }
    }

    private async markAsResolved() {
        try {
            await this.apiClient.updateFindingStatus(this.currentFinding.id, 'resolved');
            vscode.window.showInformationMessage('Marked as resolved');
            this.panel.webview.postMessage({ command: 'statusUpdated', status: 'resolved' });
        } catch (error: any) {
            vscode.window.showErrorMessage('Failed to update status: ' + error.message);
        }
    }

    private async markAsFalsePositive() {
        try {
            await this.apiClient.updateFindingStatus(this.currentFinding.id, 'false_positive');
            vscode.window.showInformationMessage('Marked as false positive');
            this.panel.webview.postMessage({ command: 'statusUpdated', status: 'false_positive' });
        } catch (error: any) {
            vscode.window.showErrorMessage('Failed to update status: ' + error.message);
        }
    }

    private async openFileAtLine() {
        try {
            let filePath = this.currentFinding.file;

            // Resolve relative path to absolute path using workspace folder
            if (!filePath.startsWith('/') && !filePath.match(/^[a-zA-Z]:\\/)) {
                const workspaceFolders = vscode.workspace.workspaceFolders;
                if (workspaceFolders && workspaceFolders.length > 0) {
                    filePath = vscode.Uri.joinPath(workspaceFolders[0].uri, filePath).fsPath;
                }
            }

            const fileUri = vscode.Uri.file(filePath);
            const document = await vscode.workspace.openTextDocument(fileUri);
            const editor = await vscode.window.showTextDocument(document, vscode.ViewColumn.One);

            const line = Math.max(0, (this.currentFinding.line || 1) - 1);
            const lineLength = document.lineAt(line).text.length;
            const range = new vscode.Range(line, 0, line, lineLength);

            // Highlight the entire line
            editor.selection = new vscode.Selection(range.start, range.end);
            editor.revealRange(range, vscode.TextEditorRevealType.InCenter);

            // Add a decoration to make the line more visible
            const decorationType = vscode.window.createTextEditorDecorationType({
                backgroundColor: 'rgba(255, 0, 0, 0.2)',
                isWholeLine: true,
                borderWidth: '1px',
                borderStyle: 'solid',
                borderColor: 'rgba(255, 0, 0, 0.5)'
            });
            editor.setDecorations(decorationType, [range]);

            // Clear decoration after 3 seconds
            setTimeout(() => {
                decorationType.dispose();
            }, 3000);

        } catch (error: any) {
            vscode.window.showErrorMessage('Failed to open file: ' + error.message);
        }
    }

    private async copyRemediationCode() {
        if (this.currentFinding.remediation_code) {
            await vscode.env.clipboard.writeText(this.currentFinding.remediation_code);
            vscode.window.showInformationMessage('Remediation code copied to clipboard');
        }
    }

    private async openChatbotWithContext() {
        // Open the chatbot panel with the current vulnerability context
        ChatbotPanel.show(this.apiClient, this.currentFinding);
        vscode.window.showInformationMessage('Opening AI Assistant with vulnerability context...');
    }

    private getHtmlContent(): string {
        const finding = this.currentFinding;

        const severityColors: {[key: string]: {bg: string, text: string, border: string}} = {
            'critical': { bg: '#fef2f2', text: '#dc2626', border: '#fca5a5' },
            'high': { bg: '#fff7ed', text: '#ea580c', border: '#fdba74' },
            'medium': { bg: '#fefce8', text: '#ca8a04', border: '#fde047' },
            'low': { bg: '#f0fdf4', text: '#16a34a', border: '#86efac' }
        };

        const severity = finding.severity.toLowerCase();
        const colors = severityColors[severity] || severityColors['low'];

        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
    <title>Vulnerability Details</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 0;
            background: #1e1e1e;
            color: #cccccc;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .severity-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: ${colors.bg};
            color: ${colors.text};
            border: 2px solid ${colors.border};
        }

        .file-location {
            font-size: 14px;
            opacity: 0.95;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            transition: background 0.2s;
        }

        .file-location:hover {
            background: rgba(255,255,255,0.2);
        }

        .content {
            padding: 24px;
        }

        .section {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #3e3e42;
        }

        .section h2 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #4ec9b0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 18px;
        }

        .description {
            color: #d4d4d4;
            margin-bottom: 12px;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .meta-item {
            background: #1e1e1e;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid ${colors.text};
        }

        .meta-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #858585;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 14px;
            color: #d4d4d4;
            font-weight: 500;
        }

        .impact-list, .steps-list {
            list-style: none;
            padding: 0;
        }

        .impact-list li, .steps-list li {
            padding: 12px;
            margin-bottom: 8px;
            background: #1e1e1e;
            border-radius: 6px;
            border-left: 3px solid ${colors.text};
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .impact-list li::before {
            content: '‚ö†Ô∏è';
            font-size: 16px;
        }

        .steps-list li {
            border-left-color: #4ec9b0;
            counter-increment: step-counter;
            position: relative;
        }

        .steps-list {
            counter-reset: step-counter;
        }

        .steps-list li::before {
            content: counter(step-counter);
            background: #4ec9b0;
            color: #1e1e1e;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
        }

        .code-block {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3e3e42;
        }

        .code-label {
            font-size: 12px;
            color: #858585;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        pre {
            margin: 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        code {
            color: #ce9178;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3e3e42;
            color: #cccccc;
            border: 1px solid #858585;
        }

        .btn-secondary:hover {
            background: #4e4e52;
        }

        .btn-icon {
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: #858585;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .tag {
            padding: 4px 12px;
            background: #3e3e42;
            border-radius: 12px;
            font-size: 12px;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>üêõ</span>
            <span>${this.escapeHtml(finding.title)}</span>
        </h1>
        <div class="file-location" onclick="openFile()">
            <span>üìÅ</span>
            <span>${this.escapeHtml(finding.file)}:${finding.line || 1}</span>
            <span style="margin-left: auto; opacity: 0.7;">‚Üí Click to open</span>
        </div>
    </div>

    <div class="content">
        <div class="section">
            <h2><span class="section-icon">üìã</span>Overview</h2>
            <div class="description">${this.escapeHtml(finding.description || 'No description available')}</div>

            <div class="meta-grid">
                <div class="meta-item">
                    <div class="meta-label">Severity</div>
                    <div class="meta-value">
                        <span class="severity-badge">${finding.severity}</span>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Category</div>
                    <div class="meta-value">${this.escapeHtml(finding.category || finding.owasp_category || 'N/A')}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">CWE ID</div>
                    <div class="meta-value">${this.escapeHtml(finding.cwe_id || 'N/A')}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Line Number</div>
                    <div class="meta-value">${finding.line || 1}</div>
                </div>
            </div>
        </div>

        ${finding.code_snippet ? `
        <div class="section">
            <h2><span class="section-icon">üíª</span>Vulnerable Code</h2>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-label">Current Code</span>
                </div>
                <pre><code>${this.escapeHtml(finding.code_snippet)}</code></pre>
            </div>
        </div>
        ` : ''}

        <div class="section">
            <h2><span class="section-icon">‚ö†Ô∏è</span>Impact</h2>
            <ul class="impact-list">
                ${this.getImpactItems(finding).map(item => `<li><span>${this.escapeHtml(item)}</span></li>`).join('')}
            </ul>
        </div>

        ${this.renderInterproceduralSection(finding)}

        <div class="section">
            <h2><span class="section-icon">üîß</span>Remediation Steps</h2>
            <ol class="steps-list">
                ${this.getRemediationSteps(finding).map(step => `<li><span>${this.escapeHtml(step)}</span></li>`).join('')}
            </ol>
        </div>

        <div class="section">
            <h2><span class="section-icon">‚ú®</span>Suggested Fix</h2>
            ${finding.remediation_code || finding.suggested_fix ? `
            <div class="code-block">
                <div class="code-header">
                    <span class="code-label">Remediation Code</span>
                    <button class="btn btn-secondary" onclick="copyCode()" style="padding: 6px 12px; font-size: 12px;">
                        <span class="btn-icon">üìã</span> Copy
                    </button>
                </div>
                <pre><code>${this.escapeHtml(finding.remediation_code || finding.suggested_fix)}</code></pre>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="applyFix()">
                    <span class="btn-icon">üîß</span>
                    Apply Fix
                </button>
                <button class="btn btn-success" onclick="applyAndCommit()">
                    <span class="btn-icon">‚úÖ</span>
                    Apply & Commit to Git
                </button>
            </div>
            ` : `
            <div class="code-block">
                <div class="code-header">
                    <span class="code-label">General Remediation Example</span>
                </div>
                <pre><code>${this.escapeHtml(this.generateRemediationCode(finding))}</code></pre>
            </div>
            <p style="color: #858585; font-size: 13px; margin-top: 12px;">
                ‚ö†Ô∏è This is a general example. Adapt it to your specific codebase and context.
            </p>
            `}
        </div>

        <div class="section">
            <h2><span class="section-icon">üè∑Ô∏è</span>Actions</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="discussWithAI()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span class="btn-icon">üí¨</span>
                    Discuss with AI Assistant
                </button>
                <button class="btn btn-success" onclick="markResolved()">
                    <span class="btn-icon">‚úì</span>
                    Mark as Resolved
                </button>
                <button class="btn btn-warning" onclick="markFalsePositive()">
                    <span class="btn-icon">‚äò</span>
                    Mark as False Positive
                </button>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        function applyFix() {
            vscode.postMessage({ command: 'applyFix' });
        }

        function applyAndCommit() {
            vscode.postMessage({ command: 'applyAndCommit' });
        }

        function markResolved() {
            vscode.postMessage({ command: 'markResolved' });
        }

        function markFalsePositive() {
            vscode.postMessage({ command: 'markFalsePositive' });
        }

        function openFile() {
            vscode.postMessage({ command: 'openFile' });
        }

        function copyCode() {
            vscode.postMessage({ command: 'copyCode' });
        }

        function discussWithAI() {
            vscode.postMessage({ command: 'discussWithAI' });
        }

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'fixApplied':
                    console.log('Fix applied successfully');
                    break;
                case 'statusUpdated':
                    console.log('Status updated to:', message.status);
                    break;
            }
        });
    </script>
</body>
</html>`;
    }

    private getImpactItems(finding: any): string[] {
        if (finding.impact && typeof finding.impact === 'string') {
            // Split multi-line impact into array
            return finding.impact.split('\n').filter((line: string) => line.trim()).map((line: string) => line.trim());
        }

        if (finding.impact && Array.isArray(finding.impact)) {
            return finding.impact;
        }

        // Generate detailed impact based on vulnerability type and severity
        const category = (finding.category || finding.owasp_category || '').toLowerCase();
        const severity = finding.severity.toLowerCase();

        // Category-specific impacts
        if (category.includes('injection') || category.includes('sql')) {
            return [
                'üî¥ Database Compromise: Attackers can execute arbitrary SQL commands, potentially reading, modifying, or deleting sensitive data',
                'üî¥ Data Exfiltration: Complete database contents including user credentials, personal information, and business data can be stolen',
                'üî¥ Authentication Bypass: Attackers can bypass login mechanisms and gain unauthorized administrative access',
                'üî¥ Data Integrity Loss: Critical business data can be modified or deleted, causing operational disruption',
                'üî¥ Compliance Violations: May result in GDPR, HIPAA, PCI-DSS violations with significant financial penalties',
                '‚ö†Ô∏è Reputation Damage: Data breaches severely impact customer trust and brand reputation'
            ];
        }

        if (category.includes('xss') || category.includes('cross-site')) {
            return [
                'üü† Session Hijacking: Attackers can steal user session cookies and impersonate legitimate users',
                'üü† Credential Theft: Login credentials can be captured through fake login forms injected into the page',
                'üü† Malware Distribution: Malicious scripts can redirect users to phishing sites or download malware',
                'üü† Account Takeover: User accounts can be compromised, leading to unauthorized actions',
                'üü† Data Theft: Sensitive information displayed in the page can be exfiltrated to attacker-controlled servers',
                '‚ö†Ô∏è User Trust Loss: Successful attacks damage user confidence and platform credibility'
            ];
        }

        if (category.includes('auth') || category.includes('access')) {
            return [
                'üî¥ Unauthorized Access: Attackers can bypass authentication and access restricted resources',
                'üî¥ Privilege Escalation: Low-privilege users can gain administrative access',
                'üî¥ Data Breach: Protected data becomes accessible to unauthorized parties',
                'üî¥ System Compromise: Critical system functions can be accessed and manipulated',
                '‚ö†Ô∏è Compliance Risk: Violates access control requirements in security standards'
            ];
        }

        if (category.includes('crypto') || category.includes('encryption')) {
            return [
                'üü† Data Exposure: Encrypted data can be decrypted by attackers using known vulnerabilities',
                'üü† Password Compromise: Weak hashing allows password cracking through rainbow tables',
                'üü† Man-in-the-Middle: Insecure communication channels can be intercepted',
                'üü† Compliance Violations: Fails to meet encryption standards (FIPS 140-2, PCI-DSS)',
                '‚ö†Ô∏è Long-term Risk: Encrypted data remains vulnerable even after the vulnerability is fixed'
            ];
        }

        if (category.includes('secret') || category.includes('credential')) {
            return [
                'üî¥ Immediate Exposure: Credentials are publicly visible in source code or repositories',
                'üî¥ Full System Access: Exposed API keys or passwords grant complete system access',
                'üî¥ Third-party Service Compromise: API keys for external services can be exploited',
                'üî¥ Financial Loss: Cloud service credentials can lead to resource abuse and unexpected bills',
                'üî¥ Supply Chain Attack: Compromised credentials can be used to attack downstream systems',
                '‚ö†Ô∏è Difficult Remediation: All exposed credentials must be rotated immediately'
            ];
        }

        // Severity-based fallback impacts
        const severityImpacts: {[key: string]: string[]} = {
            'critical': [
                'üî¥ Complete System Compromise: Attackers can gain full control over the application and underlying infrastructure',
                'üî¥ Massive Data Breach: All stored data including user information, business data, and credentials are at risk',
                'üî¥ Remote Code Execution: Attackers can execute arbitrary code on the server',
                'üî¥ Service Disruption: Application availability and integrity can be completely destroyed',
                'üî¥ Regulatory Penalties: Severe compliance violations may result in millions in fines',
                '‚ö†Ô∏è Immediate Action Required: This vulnerability must be patched within 24-48 hours'
            ],
            'high': [
                'üü† Significant Security Risk: Successful exploitation can lead to major security incidents',
                'üü† Data Exposure: Sensitive business or user data may be accessed or stolen',
                'üü† Authentication Bypass: Security controls can be circumvented',
                'üü† Privilege Escalation: Attackers can gain elevated access rights',
                'üü† Business Impact: Operations may be disrupted, causing financial and reputational damage',
                '‚ö†Ô∏è Priority Fix: Should be addressed within 7-14 days'
            ],
            'medium': [
                'üü° Security Weakness: Vulnerability exists but requires specific conditions to exploit',
                'üü° Limited Exposure: Impact is constrained to specific functionality or data',
                'üü° Attack Chain Component: Can be combined with other vulnerabilities for greater impact',
                'üü° Defense-in-Depth Gap: Reduces overall security posture',
                '‚ö†Ô∏è Recommended Fix: Should be addressed in the next development cycle (30 days)'
            ],
            'low': [
                'üü¢ Minor Security Concern: Limited security impact with difficult exploitation',
                'üü¢ Information Disclosure: Minor data leakage without direct security impact',
                'üü¢ Best Practice Violation: Doesn\'t follow security guidelines',
                '‚ö†Ô∏è Future Enhancement: Can be addressed in regular maintenance (90 days)'
            ]
        };

        return severityImpacts[severity] || [
            '‚ö†Ô∏è Security Vulnerability: This issue represents a potential security risk',
            '‚ö†Ô∏è Exploitation Possible: Attackers may be able to exploit this weakness',
            '‚ö†Ô∏è Security Posture: Overall application security is compromised',
            '‚ö†Ô∏è Recommended Action: Review and remediate based on risk assessment'
        ];
    }

    private getRemediationSteps(finding: any): string[] {
        if (finding.remediation_steps && Array.isArray(finding.remediation_steps) && finding.remediation_steps.length > 0) {
            return finding.remediation_steps;
        }

        if (finding.remediation && typeof finding.remediation === 'string') {
            const steps = finding.remediation.split('\n').filter((s: string) => s.trim());
            if (steps.length > 0) {
                return steps;
            }
        }

        // Generate detailed remediation steps based on category
        const category = (finding.category || finding.owasp_category || '').toLowerCase();
        const file = finding.file;
        const line = finding.line;

        if (category.includes('injection') || category.includes('sql')) {
            return [
                `üîç Locate the vulnerable code in ${file}:${line} where user input is being directly concatenated into SQL queries`,
                'üõ°Ô∏è Replace dynamic SQL with parameterized queries or prepared statements - this is the ONLY secure approach',
                '‚úÖ Example (Correct): cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,)) instead of f"SELECT * FROM users WHERE id = {user_id}"',
                'üßπ Remove all string concatenation or string formatting in SQL queries (no +, f-strings, or .format())',
                'üîí Implement input validation: whitelist allowed characters, limit input length, and validate data types',
                'üß™ Test with SQL injection payloads: try inputs like \' OR \'1\'=\'1, admin\'--,  and UNION SELECT to verify fixes',
                'üîê Enable least-privilege database access: application accounts should have minimal required permissions',
                'üìä Run automated security scan to confirm vulnerability is resolved',
                '‚úçÔ∏è Commit changes with message: "fix(security): Prevent SQL injection by using parameterized queries"',
                'üöÄ Deploy to staging environment and perform penetration testing before production release'
            ];
        }

        if (category.includes('xss') || category.includes('cross-site')) {
            return [
                `üîç Identify where user input is being rendered in ${file}:${line} without proper encoding`,
                'üõ°Ô∏è Apply context-aware output encoding based on where data is used (HTML, JavaScript, URL, CSS)',
                '‚úÖ For HTML context: Use HTML entity encoding (convert <, >, &, ", \' to &lt;, &gt;, &amp;, &quot;, &#x27;)',
                '‚úÖ For JavaScript: Use JavaScript encoding and avoid inline event handlers entirely',
                'üö´ Never use dangerous functions: Avoid innerHTML, document.write(), eval(), setTimeout/setInterval with strings',
                'üîí Implement Content Security Policy (CSP) headers to block inline scripts and restrict script sources',
                'üßπ Use framework-specific safe methods: React\'s JSX auto-escapes, Angular\'s DomSanitizer, Vue\'s v-text',
                'üß™ Test with XSS payloads: <script>alert(1)</script>, <img src=x onerror=alert(1)>, javascript:alert(1)',
                'üìä Verify fixes with automated XSS detection tools and manual testing',
                '‚úçÔ∏è Commit: "fix(security): Prevent XSS by implementing proper output encoding"'
            ];
        }

        if (category.includes('auth') || category.includes('access')) {
            return [
                `üîç Review authentication/authorization logic in ${file}:${line}`,
                'üõ°Ô∏è Implement proper access control checks before any sensitive operations',
                '‚úÖ Use framework-built-in decorators/middleware: @login_required, @permission_required, or similar',
                'üîí Verify user identity AND permissions: check both "who are you?" and "what can you do?"',
                'üéØ Follow principle of least privilege: deny by default, explicitly grant access',
                'üîê Implement role-based access control (RBAC) or attribute-based access control (ABAC)',
                'üß™ Test with different user roles: admin, regular user, guest, and unauthenticated',
                'üìù Log all authorization failures for security monitoring',
                '‚úçÔ∏è Commit: "fix(security): Implement proper authentication and authorization checks"',
                'üöÄ Conduct thorough testing of all protected endpoints before deployment'
            ];
        }

        if (category.includes('crypto') || category.includes('encryption')) {
            return [
                `üîç Identify weak cryptographic algorithm usage in ${file}:${line}`,
                'üõ°Ô∏è Replace with modern, secure algorithms: Use bcrypt/Argon2 for passwords, AES-256-GCM for data',
                '‚úÖ For password hashing: Use bcrypt (work factor >= 10), scrypt, or Argon2id',
                '‚úÖ For encryption: Use AES-256-GCM with proper IV generation, never reuse IVs',
                'üö´ Remove weak algorithms: MD5, SHA-1, DES, 3DES, RC4, and ECB mode are all insecure',
                'üîë Implement proper key management: Store keys in secure vaults (AWS KMS, Azure Key Vault, HashiCorp Vault)',
                'üîê Use authenticated encryption (AEAD): Ensures both confidentiality and integrity',
                'üß™ Test password hashes: Verify they cannot be quickly cracked with hashcat or john',
                '‚úçÔ∏è Commit: "fix(security): Upgrade to secure cryptographic algorithms"',
                '‚ö†Ô∏è Plan credential rotation: All data encrypted with old algorithms must be re-encrypted'
            ];
        }

        if (category.includes('secret') || category.includes('credential')) {
            return [
                `üîç Locate hardcoded credentials in ${file}:${line}`,
                'üö® IMMEDIATE ACTION: Rotate/revoke exposed credentials before any code changes',
                'üõ°Ô∏è Move secrets to environment variables: Use process.env, os.environ, or System.getenv()',
                '‚úÖ Use secret management services: AWS Secrets Manager, Azure Key Vault, or HashiCorp Vault',
                'üîí Never commit secrets to version control: Add patterns to .gitignore immediately',
                'üßπ Scrub git history: Use tools like git-filter-repo or BFG Repo-Cleaner to remove historical secrets',
                'üîë Implement secret scanning in CI/CD: Tools like detect-secrets, git-secrets, or Gitleaks',
                'üìù Document secret rotation procedure for team members',
                '‚úçÔ∏è Commit: "fix(security): Remove hardcoded credentials, use environment variables"',
                'üîÑ Verify all instances across all branches and repositories are remediated'
            ];
        }

        // Generic detailed remediation steps
        return [
            `üîç Step 1: Thoroughly review the vulnerable code at ${file}:${line} to understand the root cause`,
            'üìö Step 2: Research the specific vulnerability type and understand common attack patterns and exploitation techniques',
            'üõ°Ô∏è Step 3: Identify the secure coding practice that should be applied (input validation, output encoding, parameterization, etc.)',
            '‚úÖ Step 4: Implement the fix following security best practices and framework-specific secure coding guidelines',
            'üß™ Step 5: Write unit tests and security tests to verify the vulnerability is resolved and prevent regression',
            'üîç Step 6: Perform code review with security focus - have another developer verify the fix',
            'üìä Step 7: Re-run automated security scanning tools to confirm the vulnerability no longer exists',
            'üßπ Step 8: Check for similar patterns across the entire codebase and fix them proactively',
            '‚úçÔ∏è Step 9: Commit changes with clear, descriptive message explaining the security fix',
            'üöÄ Step 10: Test thoroughly in staging environment before deploying to production',
            'üìù Step 11: Update security documentation and add the vulnerability pattern to your security checklist',
            'üéì Step 12: Share learnings with the team to prevent similar issues in future development'
        ];
    }

    private renderInterproceduralSection(finding: any): string {
        const callChain = finding.call_chain || finding.callChain || [];
        const functionSummary = finding.function_summary || finding.functionSummary;
        const crossFunctionFlow = finding.cross_function_flow || finding.taintFlow?.path;

        // Only render if there's inter-procedural data
        if (callChain.length === 0 && !functionSummary && !crossFunctionFlow) {
            return '';
        }

        let html = `
        <div class="section" style="border-left: 4px solid #a78bfa;">
            <h2><span class="section-icon">üîó</span>Inter-Procedural Analysis</h2>
            <p style="color: #858585; font-size: 13px; margin-bottom: 16px;">
                This vulnerability was detected using cross-function data flow analysis,
                tracking tainted data across function boundaries.
            </p>
        `;

        // Render call chain
        if (callChain.length > 0) {
            html += `
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; color: #4ec9b0; margin-bottom: 12px;">üìû Call Chain</h3>
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; padding: 16px; background: #1e1e1e; border-radius: 8px;">
            `;

            callChain.forEach((func: string, idx: number) => {
                const isLast = idx === callChain.length - 1;
                const isFirst = idx === 0;
                const bgColor = isFirst ? 'rgba(255, 107, 107, 0.2)' : isLast ? 'rgba(251, 191, 36, 0.2)' : 'rgba(167, 139, 250, 0.2)';
                const borderColor = isFirst ? '#ff6b6b' : isLast ? '#fbbf24' : '#a78bfa';
                const label = isFirst ? 'üì• Source' : isLast ? '‚ö†Ô∏è Sink' : 'üîÑ';

                html += `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 10px; color: #858585; margin-bottom: 4px;">${label}</span>
                        <code style="padding: 8px 14px; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; font-size: 12px; color: #d4d4d4;">${this.escapeHtml(func)}</code>
                    </div>
                `;

                if (!isLast) {
                    html += `<span style="color: #a78bfa; font-size: 18px; margin: 0 4px;">‚Üí</span>`;
                }
            });

            html += `</div></div>`;
        }

        // Render function summary
        if (functionSummary) {
            html += `
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; color: #4ec9b0; margin-bottom: 12px;">üìã Function Summary</h3>
                <div style="padding: 16px; background: #1e1e1e; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <span style="font-size: 11px; color: #858585; text-transform: uppercase;">Function Name</span>
                            <div style="font-size: 13px; color: #d4d4d4; margin-top: 4px;"><code>${this.escapeHtml(functionSummary.name || 'N/A')}</code></div>
                        </div>
                        ${functionSummary.taint_behavior ? `
                        <div>
                            <span style="font-size: 11px; color: #858585; text-transform: uppercase;">Taint Behavior</span>
                            <div style="font-size: 13px; color: #fbbf24; margin-top: 4px;">${this.escapeHtml(functionSummary.taint_behavior)}</div>
                        </div>
                        ` : ''}
                        ${functionSummary.tainted_params ? `
                        <div>
                            <span style="font-size: 11px; color: #858585; text-transform: uppercase;">Tainted Parameters</span>
                            <div style="font-size: 13px; color: #ff6b6b; margin-top: 4px;">${functionSummary.tainted_params.map((p: string) => `<code>${this.escapeHtml(p)}</code>`).join(', ')}</div>
                        </div>
                        ` : ''}
                        ${functionSummary.returns_tainted !== undefined ? `
                        <div>
                            <span style="font-size: 11px; color: #858585; text-transform: uppercase;">Returns Tainted</span>
                            <div style="font-size: 13px; color: ${functionSummary.returns_tainted ? '#ff6b6b' : '#34d399'}; margin-top: 4px;">${functionSummary.returns_tainted ? 'Yes ‚ö†Ô∏è' : 'No ‚úì'}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;
        }

        // Render cross-function data flow
        if (crossFunctionFlow && Array.isArray(crossFunctionFlow) && crossFunctionFlow.length > 0) {
            html += `
            <div>
                <h3 style="font-size: 14px; color: #4ec9b0; margin-bottom: 12px;">üåä Data Flow Path</h3>
                <div style="padding: 16px; background: #1e1e1e; border-radius: 8px;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
            `;

            crossFunctionFlow.forEach((step: any, idx: number) => {
                const isFirst = idx === 0;
                const isLast = idx === crossFunctionFlow.length - 1;
                const borderColor = isFirst ? '#ff6b6b' : isLast ? '#fbbf24' : '#a78bfa';
                const description = step.description || step.node_type || 'Data flow step';
                const location = step.location || {};
                const file = location.file?.split('/').pop() || '';
                const line = location.startLine || location.line || '';

                html += `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 24px;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${borderColor}; display: flex; align-items: center; justify-content: center; color: #000; font-size: 11px; font-weight: bold;">${idx + 1}</div>
                            ${!isLast ? '<div style="width: 2px; height: 20px; background: #3e3e42; margin-top: 4px;"></div>' : ''}
                        </div>
                        <div style="flex: 1; padding: 8px 12px; background: #252526; border-radius: 6px; border-left: 3px solid ${borderColor};">
                            <div style="font-size: 12px; color: #d4d4d4;">${this.escapeHtml(description)}</div>
                            ${file ? `<div style="font-size: 11px; color: #858585; margin-top: 4px;">üìç ${this.escapeHtml(file)}${line ? ':' + line : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div></div></div>`;
        }

        html += `</div>`;
        return html;
    }

    private generateRemediationCode(finding: any): string {
        const category = (finding.category || finding.owasp_category || '').toLowerCase();

        if (category.includes('injection') || category.includes('sql')) {
            return `# BEFORE (Vulnerable):
query = f"SELECT * FROM users WHERE id = {user_id}"
cursor.execute(query)

# AFTER (Secure):
query = "SELECT * FROM users WHERE id = ?"
cursor.execute(query, (user_id,))

# OR using named parameters:
query = "SELECT * FROM users WHERE id = :user_id"
cursor.execute(query, {"user_id": user_id})`;
        }

        if (category.includes('xss') || category.includes('cross-site')) {
            return `<!-- BEFORE (Vulnerable): -->
<div id="output"></div>
<script>
  document.getElementById('output').innerHTML = userInput;
</script>

<!-- AFTER (Secure): -->
<div id="output"></div>
<script>
  // Use textContent instead of innerHTML
  document.getElementById('output').textContent = userInput;

  // OR use framework's safe rendering:
  // React: <div>{userInput}</div>
  // Vue: <div>{{ userInput }}</div>
  // Angular: <div>{{ userInput }}</div>
</script>`;
        }

        if (category.includes('auth') || category.includes('access')) {
            return `# BEFORE (Vulnerable):
@app.route('/admin/users')
def admin_users():
    return render_template('users.html')

# AFTER (Secure):
from flask_login import login_required, current_user

@app.route('/admin/users')
@login_required
def admin_users():
    if not current_user.is_admin:
        abort(403)  # Forbidden
    return render_template('users.html')`;
        }

        if (category.includes('crypto') || category.includes('encryption')) {
            return `# BEFORE (Vulnerable):
import hashlib
password_hash = hashlib.md5(password.encode()).hexdigest()

# AFTER (Secure):
import bcrypt

# Hash password
password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt())

# Verify password
if bcrypt.checkpw(password.encode(), stored_hash):
    print("Password correct!")`;
        }

        if (category.includes('secret') || category.includes('credential')) {
            return `# BEFORE (Vulnerable):
API_KEY = "sk-1234567890abcdef"
DATABASE_PASSWORD = "mypassword123"

# AFTER (Secure):
import os
from dotenv import load_dotenv

load_dotenv()  # Load from .env file
API_KEY = os.getenv('API_KEY')
DATABASE_PASSWORD = os.getenv('DATABASE_PASSWORD')

# .env file (add to .gitignore):
# API_KEY=sk-1234567890abcdef
# DATABASE_PASSWORD=mypassword123`;
        }

        // Generic example
        return `// Review the vulnerable code and apply appropriate security measures:
// 1. Validate all user inputs
// 2. Use parameterized queries for databases
// 3. Encode outputs in HTML context
// 4. Implement proper access controls
// 5. Use secure cryptographic functions
// 6. Never hardcode secrets

// Consult the remediation steps above for specific guidance.`;
    }

    private escapeHtml(text: string): string {
        if (!text) return '';
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    public dispose() {
        VulnerabilityDetailsPanel.currentPanel = undefined;
        this.panel.dispose();
        while (this.disposables.length) {
            const disposable = this.disposables.pop();
            if (disposable) {
                disposable.dispose();
            }
        }
    }
}
