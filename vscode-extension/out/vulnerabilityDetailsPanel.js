"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.VulnerabilityDetailsPanel = void 0;
const vscode = __importStar(require("vscode"));
class VulnerabilityDetailsPanel {
    constructor(panel, apiClient, finding) {
        this.apiClient = apiClient;
        this.disposables = [];
        this.panel = panel;
        this.currentFinding = finding;
        this.panel.onDidDispose(() => this.dispose(), null, this.disposables);
        this.panel.webview.onDidReceiveMessage(async (message) => {
            switch (message.command) {
                case 'applyFix':
                    await this.applyFix();
                    break;
                case 'applyAndCommit':
                    await this.applyFixAndCommit();
                    break;
                case 'markResolved':
                    await this.markAsResolved();
                    break;
                case 'markFalsePositive':
                    await this.markAsFalsePositive();
                    break;
                case 'openFile':
                    await this.openFileAtLine();
                    break;
                case 'copyCode':
                    await this.copyRemediationCode();
                    break;
            }
        }, null, this.disposables);
    }
    static show(finding, apiClient) {
        const column = vscode.ViewColumn.Two;
        if (VulnerabilityDetailsPanel.currentPanel) {
            VulnerabilityDetailsPanel.currentPanel.currentFinding = finding;
            VulnerabilityDetailsPanel.currentPanel.panel.reveal(column);
            VulnerabilityDetailsPanel.currentPanel.update();
        }
        else {
            const panel = vscode.window.createWebviewPanel('vulnerabilityDetails', 'Vulnerability Details', column, {
                enableScripts: true,
                retainContextWhenHidden: true,
                localResourceRoots: []
            });
            VulnerabilityDetailsPanel.currentPanel = new VulnerabilityDetailsPanel(panel, apiClient, finding);
            VulnerabilityDetailsPanel.currentPanel.update();
        }
    }
    update() {
        this.panel.title = `üêõ ${this.currentFinding.title}`;
        this.panel.webview.html = this.getHtmlContent();
    }
    async applyFix() {
        const finding = this.currentFinding;
        if (!finding.remediation_code) {
            vscode.window.showWarningMessage('No remediation code available');
            return;
        }
        try {
            await vscode.window.withProgress({
                location: vscode.ProgressLocation.Notification,
                title: 'Applying fix...',
                cancellable: false
            }, async () => {
                const document = await vscode.workspace.openTextDocument(finding.file);
                await vscode.window.showTextDocument(document);
                const edit = new vscode.WorkspaceEdit();
                const line = Math.max(0, (finding.line || 1) - 1);
                const lineText = document.lineAt(line);
                const range = lineText.range;
                edit.replace(document.uri, range, finding.remediation_code);
                const success = await vscode.workspace.applyEdit(edit);
                if (success) {
                    await document.save();
                    vscode.window.showInformationMessage('‚úÖ Fix applied successfully!');
                    this.panel.webview.postMessage({ command: 'fixApplied' });
                }
            });
        }
        catch (error) {
            vscode.window.showErrorMessage('Failed to apply fix: ' + error.message);
        }
    }
    async applyFixAndCommit() {
        await this.applyFix();
        const finding = this.currentFinding;
        // Prompt user for commit confirmation
        const commit = await vscode.window.showQuickPick(['Yes, commit changes', 'No, just apply fix'], {
            placeHolder: 'Do you want to commit this fix to git?'
        });
        if (commit !== 'Yes, commit changes') {
            return;
        }
        try {
            await vscode.window.withProgress({
                location: vscode.ProgressLocation.Notification,
                title: 'Committing fix to git...',
                cancellable: false
            }, async () => {
                const terminal = vscode.window.createTerminal({
                    name: 'AppSec Auto-Remediation',
                    hideFromUser: false
                });
                terminal.show();
                const commitMsg = `fix(security): ${finding.title}

Auto-remediated by AppSec AI Scanner

Severity: ${finding.severity}
CWE: ${finding.cwe_id || 'N/A'}
File: ${finding.file}:${finding.line}

ü§ñ Generated by AppSec AI Scanner`;
                // Escape quotes in file path
                const safeFilePath = finding.file.replace(/"/g, '\\"');
                terminal.sendText(`git add "${safeFilePath}"`);
                await new Promise(resolve => setTimeout(resolve, 500));
                // Use heredoc for multiline commit message
                terminal.sendText(`git commit -m "${commitMsg.replace(/\n/g, '\\n')}"`);
                vscode.window.showInformationMessage('‚úÖ Fix applied and committed to git!');
            });
        }
        catch (error) {
            vscode.window.showErrorMessage('Failed to commit: ' + error.message);
        }
    }
    async markAsResolved() {
        try {
            await this.apiClient.updateFindingStatus(this.currentFinding.id, 'resolved');
            vscode.window.showInformationMessage('Marked as resolved');
            this.panel.webview.postMessage({ command: 'statusUpdated', status: 'resolved' });
        }
        catch (error) {
            vscode.window.showErrorMessage('Failed to update status: ' + error.message);
        }
    }
    async markAsFalsePositive() {
        try {
            await this.apiClient.updateFindingStatus(this.currentFinding.id, 'false_positive');
            vscode.window.showInformationMessage('Marked as false positive');
            this.panel.webview.postMessage({ command: 'statusUpdated', status: 'false_positive' });
        }
        catch (error) {
            vscode.window.showErrorMessage('Failed to update status: ' + error.message);
        }
    }
    async openFileAtLine() {
        try {
            const document = await vscode.workspace.openTextDocument(this.currentFinding.file);
            const editor = await vscode.window.showTextDocument(document, vscode.ViewColumn.One);
            const line = Math.max(0, (this.currentFinding.line || 1) - 1);
            const range = new vscode.Range(line, 0, line, 0);
            editor.selection = new vscode.Selection(range.start, range.end);
            editor.revealRange(range, vscode.TextEditorRevealType.InCenter);
        }
        catch (error) {
            vscode.window.showErrorMessage('Failed to open file: ' + error.message);
        }
    }
    async copyRemediationCode() {
        if (this.currentFinding.remediation_code) {
            await vscode.env.clipboard.writeText(this.currentFinding.remediation_code);
            vscode.window.showInformationMessage('Remediation code copied to clipboard');
        }
    }
    getHtmlContent() {
        const finding = this.currentFinding;
        const severityColors = {
            'critical': { bg: '#fef2f2', text: '#dc2626', border: '#fca5a5' },
            'high': { bg: '#fff7ed', text: '#ea580c', border: '#fdba74' },
            'medium': { bg: '#fefce8', text: '#ca8a04', border: '#fde047' },
            'low': { bg: '#f0fdf4', text: '#16a34a', border: '#86efac' }
        };
        const severity = finding.severity.toLowerCase();
        const colors = severityColors[severity] || severityColors['low'];
        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
    <title>Vulnerability Details</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 0;
            background: #1e1e1e;
            color: #cccccc;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .severity-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: ${colors.bg};
            color: ${colors.text};
            border: 2px solid ${colors.border};
        }

        .file-location {
            font-size: 14px;
            opacity: 0.95;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            transition: background 0.2s;
        }

        .file-location:hover {
            background: rgba(255,255,255,0.2);
        }

        .content {
            padding: 24px;
        }

        .section {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #3e3e42;
        }

        .section h2 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #4ec9b0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 18px;
        }

        .description {
            color: #d4d4d4;
            margin-bottom: 12px;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .meta-item {
            background: #1e1e1e;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid ${colors.text};
        }

        .meta-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #858585;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 14px;
            color: #d4d4d4;
            font-weight: 500;
        }

        .impact-list, .steps-list {
            list-style: none;
            padding: 0;
        }

        .impact-list li, .steps-list li {
            padding: 12px;
            margin-bottom: 8px;
            background: #1e1e1e;
            border-radius: 6px;
            border-left: 3px solid ${colors.text};
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .impact-list li::before {
            content: '‚ö†Ô∏è';
            font-size: 16px;
        }

        .steps-list li {
            border-left-color: #4ec9b0;
            counter-increment: step-counter;
            position: relative;
        }

        .steps-list {
            counter-reset: step-counter;
        }

        .steps-list li::before {
            content: counter(step-counter);
            background: #4ec9b0;
            color: #1e1e1e;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
        }

        .code-block {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3e3e42;
        }

        .code-label {
            font-size: 12px;
            color: #858585;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        pre {
            margin: 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        code {
            color: #ce9178;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3e3e42;
            color: #cccccc;
            border: 1px solid #858585;
        }

        .btn-secondary:hover {
            background: #4e4e52;
        }

        .btn-icon {
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: #858585;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .tag {
            padding: 4px 12px;
            background: #3e3e42;
            border-radius: 12px;
            font-size: 12px;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>üêõ</span>
            <span>${this.escapeHtml(finding.title)}</span>
        </h1>
        <div class="file-location" onclick="openFile()">
            <span>üìÅ</span>
            <span>${this.escapeHtml(finding.file)}:${finding.line || 1}</span>
            <span style="margin-left: auto; opacity: 0.7;">‚Üí Click to open</span>
        </div>
    </div>

    <div class="content">
        <div class="section">
            <h2><span class="section-icon">üìã</span>Overview</h2>
            <div class="description">${this.escapeHtml(finding.description || 'No description available')}</div>

            <div class="meta-grid">
                <div class="meta-item">
                    <div class="meta-label">Severity</div>
                    <div class="meta-value">
                        <span class="severity-badge">${finding.severity}</span>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Category</div>
                    <div class="meta-value">${this.escapeHtml(finding.category || finding.owasp_category || 'N/A')}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">CWE ID</div>
                    <div class="meta-value">${this.escapeHtml(finding.cwe_id || 'N/A')}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Line Number</div>
                    <div class="meta-value">${finding.line || 1}</div>
                </div>
            </div>
        </div>

        ${finding.code_snippet ? `
        <div class="section">
            <h2><span class="section-icon">üíª</span>Vulnerable Code</h2>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-label">Current Code</span>
                </div>
                <pre><code>${this.escapeHtml(finding.code_snippet)}</code></pre>
            </div>
        </div>
        ` : ''}

        <div class="section">
            <h2><span class="section-icon">‚ö†Ô∏è</span>Impact</h2>
            <ul class="impact-list">
                ${this.getImpactItems(finding).map(item => `<li><span>${this.escapeHtml(item)}</span></li>`).join('')}
            </ul>
        </div>

        <div class="section">
            <h2><span class="section-icon">üîß</span>Remediation Steps</h2>
            <ol class="steps-list">
                ${this.getRemediationSteps(finding).map(step => `<li><span>${this.escapeHtml(step)}</span></li>`).join('')}
            </ol>
        </div>

        ${finding.remediation_code ? `
        <div class="section">
            <h2><span class="section-icon">‚ú®</span>Suggested Fix</h2>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-label">Remediation Code</span>
                    <button class="btn btn-secondary" onclick="copyCode()" style="padding: 6px 12px; font-size: 12px;">
                        <span class="btn-icon">üìã</span> Copy
                    </button>
                </div>
                <pre><code>${this.escapeHtml(finding.remediation_code)}</code></pre>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="applyFix()">
                    <span class="btn-icon">üîß</span>
                    Apply Fix
                </button>
                <button class="btn btn-success" onclick="applyAndCommit()">
                    <span class="btn-icon">‚úÖ</span>
                    Apply & Commit to Git
                </button>
            </div>
        </div>
        ` : '<div class="section"><div class="empty-state">No automated fix available for this vulnerability</div></div>'}

        <div class="section">
            <h2><span class="section-icon">üè∑Ô∏è</span>Actions</h2>
            <div class="actions">
                <button class="btn btn-success" onclick="markResolved()">
                    <span class="btn-icon">‚úì</span>
                    Mark as Resolved
                </button>
                <button class="btn btn-warning" onclick="markFalsePositive()">
                    <span class="btn-icon">‚äò</span>
                    Mark as False Positive
                </button>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        function applyFix() {
            vscode.postMessage({ command: 'applyFix' });
        }

        function applyAndCommit() {
            vscode.postMessage({ command: 'applyAndCommit' });
        }

        function markResolved() {
            vscode.postMessage({ command: 'markResolved' });
        }

        function markFalsePositive() {
            vscode.postMessage({ command: 'markFalsePositive' });
        }

        function openFile() {
            vscode.postMessage({ command: 'openFile' });
        }

        function copyCode() {
            vscode.postMessage({ command: 'copyCode' });
        }

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'fixApplied':
                    console.log('Fix applied successfully');
                    break;
                case 'statusUpdated':
                    console.log('Status updated to:', message.status);
                    break;
            }
        });
    </script>
</body>
</html>`;
    }
    getImpactItems(finding) {
        if (finding.impact && typeof finding.impact === 'string') {
            return [finding.impact];
        }
        if (finding.impact && Array.isArray(finding.impact)) {
            return finding.impact;
        }
        const impactMap = {
            'critical': [
                'Remote code execution possible',
                'Complete system compromise',
                'Data breach and unauthorized access',
                'Immediate action required'
            ],
            'high': [
                'Significant security risk',
                'Potential data exposure',
                'Authentication/authorization bypass possible',
                'Exploitation likely'
            ],
            'medium': [
                'Security weakness present',
                'Could be chained with other vulnerabilities',
                'Increases attack surface',
                'Should be addressed soon'
            ],
            'low': [
                'Minor security concern',
                'Limited exploitability',
                'Good security practice to fix',
                'Low priority remediation'
            ]
        };
        return impactMap[finding.severity.toLowerCase()] || [
            'Potential security vulnerability',
            'Could be exploited by attackers',
            'May compromise application security'
        ];
    }
    getRemediationSteps(finding) {
        if (finding.remediation_steps && Array.isArray(finding.remediation_steps) && finding.remediation_steps.length > 0) {
            return finding.remediation_steps;
        }
        if (finding.remediation && typeof finding.remediation === 'string') {
            const steps = finding.remediation.split('\n').filter((s) => s.trim());
            if (steps.length > 0) {
                return steps;
            }
        }
        return [
            `Review the vulnerable code at ${finding.file}:${finding.line}`,
            'Understand the security implications and attack vectors',
            'Apply the suggested fix or implement custom remediation',
            'Test the changes thoroughly in a development environment',
            'Run security scan again to verify the fix',
            'Commit the changes to your repository',
            'Deploy to production after validation'
        ];
    }
    escapeHtml(text) {
        if (!text)
            return '';
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    dispose() {
        VulnerabilityDetailsPanel.currentPanel = undefined;
        this.panel.dispose();
        while (this.disposables.length) {
            const disposable = this.disposables.pop();
            if (disposable) {
                disposable.dispose();
            }
        }
    }
}
exports.VulnerabilityDetailsPanel = VulnerabilityDetailsPanel;
//# sourceMappingURL=vulnerabilityDetailsPanel.js.map